%% Designed for use with parallel script
% This function takes a single file, splits it into segments & passes that
% segment to the sub function where the actual decimation occurs
%
% Note: To maintain filter state between file segments
%        we set the filter state to persistent
%
% Written by Raied Caromi & John Mink
% Version: 1.0
% Date: 24 Feb 2017

function parDecimate_sub_file(radar_filepath,init_seekPositionSamples,samplesPerSegment,ElementsPerSample,BytesPerSample,freq_shift,old_Fs,new_Fs,save_filepath)
    %%
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%% Create Filter from numerator coefficients %%%
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    filtNumerator = [-1.5911e-19 -5.136e-05 -0.00011054 -0.0001692 -0.00021713 ...
             -0.00024359 -0.00023907 -0.00019712 -0.00011603 ...
             4.1213e-19 0.00014048 0.0002891 0.0004253 0.00052671 ...
             0.00057223 0.00054548 0.00043795 0.00025158 -7.7659e-19 ...
             -0.00029165 -0.00058872 -0.00085062 -0.0010358 -0.0011078 ...
             -0.0010405 -0.00082381 -0.00046707 1.2461e-18 0.00052861 ...
             0.0010553 0.0015089 0.0018194 0.0019275 0.0017944 ...
             0.0014088 0.00079239 -1.7983e-18 -0.00088365 -0.0017521 ...
             -0.0024892 -0.0029833 -0.0031426 -0.0029099 -0.0022732 ...
             -0.0012726 2.3962e-18 0.0014072 0.00278 0.0039361 ...
             0.0047029 0.0049406 0.0045638 0.003558 0.0019885 ...
             -2.9915e-18 -0.0021941 -0.0043321 -0.0061332 -0.0073306 ...
             -0.0077075 -0.007129 -0.0055682 -0.0031195 3.5304e-18 ...
             0.0034653 0.0068726 0.0097809 0.011762 0.012455 0.011614 ...
             0.009157 0.0051854 -3.9606e-18 -0.0059137 -0.011918 ...
             -0.017277 -0.021221 -0.023026 -0.022089 -0.018 -0.010597 ...
             4.2383e-18 0.013379 0.028856 0.04552 0.062305 0.078075 ...
             0.091722 0.10226 0.10891 0.11119 0.10891 0.10226 0.091722 ...
             0.078075 0.062305 0.04552 0.028856 0.013379 4.2383e-18 ...
             -0.010597 -0.018 -0.022089 -0.023026 -0.021221 -0.017277 ...
             -0.011918 -0.0059137 -3.9606e-18 0.0051854 0.009157 ...
             0.011614 0.012455 0.011762 0.0097809 0.0068726 0.0034653 ...
             3.5304e-18 -0.0031195 -0.0055682 -0.007129 -0.0077075 ...
             -0.0073306 -0.0061332 -0.0043321 -0.0021941 -2.9915e-18 ...
             0.0019885 0.003558 0.0045638 0.0049406 0.0047029 ...
             0.0039361 0.00278 0.0014072 2.3962e-18 -0.0012726 ...
             -0.0022732 -0.0029099 -0.0031426 -0.0029833 -0.0024892 ...
             -0.0017521 -0.00088365 -1.7983e-18 0.00079239 0.0014088 ...
             0.0017944 0.0019275 0.0018194 0.0015089 0.0010553 ...
             0.00052861 1.2461e-18 -0.00046707 -0.00082381 -0.0010405 ...
             -0.0011078 -0.0010358 -0.00085062 -0.00058872 -0.00029165 ...
             -7.7659e-19 0.00025158 0.00043795 0.00054548 0.00057223 ...
             0.00052671 0.0004253 0.0002891 0.00014048 4.1213e-19 ...
             -0.00011603 -0.00019712 -0.00023907 -0.00024359 ...
             -0.00021713 -0.0001692 -0.00011054 -5.136e-05 -1.5911e-19];

    Hd = dfilt.dffir(filtNumerator);
    set(Hd,'PersistentMemory',true);

    %%    
    %%%%%%%%%%%%%%%%%%%%
    %%% Setup Params %%%
    %%%%%%%%%%%%%%%%%%%%
    old_Ts=1/old_Fs;
    new_Ts=1/new_Fs;

    t0=init_seekPositionSamples*old_Ts;

    radar_file=dir(radar_filepath);

    segment_size_bytes=samplesPerSegment*BytesPerSample;
    seekStepSamples=(segment_size_bytes/BytesPerSample);

    segments_per_file=radar_file.bytes/(samplesPerSegment*BytesPerSample); % Number of Segments (in file)

    [file_id_read,errmsg_read]=fopen(radar_filepath,'r','l','UTF-8');
    [file_id_write]=fopen(save_filepath,'a','l','UTF-8');

    seekPositionSamples=init_seekPositionSamples;
    
    %%    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%% Decimate one segment at a time %%%
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    if (strcmp(errmsg_read,'')==1) % no error open
        for iter_count=1:ceil(segments_per_file)

            Data_Interleaved=fread(file_id_read,ElementsPerSample*samplesPerSegment,'int16=>double'); %in elements

            data_out_interleaved=parDecimate_sub_segment(Hd,t0,samplesPerSegment,Data_Interleaved,freq_shift,old_Fs,new_Fs,0);

            fwrite(file_id_write,data_out_interleaved,'int16'); clear data_out_interleaved;

            seekPositionSamples=seekPositionSamples+seekStepSamples;
            t0=seekPositionSamples*old_Ts;

        end %for iter_count
    end % error check
    %%    
    %%%%%%%%%%%%%%%%
    %%% Clean up %%%
    %%%%%%%%%%%%%%%%
    fclose(file_id_read);
    fclose(file_id_write);
    
end %function call